openapi: 3.1.0
info:
  title: CruiseBooking API
  description: |
    邮轮舱位预订平台 RESTful API
    
    **版本**: 1.0.0  
    **协议**: RESTful + OpenAPI 3.1
  version: 1.0.0
  contact:
    name: CruiseBooking Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development
  - url: https://api.cruisebooking.com/api/v1
    description: Production

security:
  - BearerAuth: []

paths:
  # Auth
  /auth/login:
    post:
      summary: User login
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials

  /auth/wechat-login:
    post:
      summary: WeChat Mini Program login
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                  description: WeChat login code
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'

  # Cruises
  /cruises:
    get:
      summary: List cruises
      tags:
        - Cruises
      security: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, maintenance]
        - name: company_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of cruises
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CruiseListResponse'

    post:
      summary: Create cruise
      tags:
        - Cruises
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCruiseRequest'
      responses:
        '201':
          description: Cruise created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cruise'

  /cruises/{id}:
    get:
      summary: Get cruise details
      tags:
        - Cruises
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Cruise details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CruiseDetail'

    put:
      summary: Update cruise
      tags:
        - Cruises
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCruiseRequest'
      responses:
        '200':
          description: Cruise updated

    delete:
      summary: Delete cruise (soft)
      tags:
        - Cruises
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Cruise deleted

  # Cabins
  /cabins:
    get:
      summary: List available cabins
      tags:
        - Cabins
      security: []
      parameters:
        - name: voyage_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: cabin_type_id
          in: query
          schema:
            type: string
            format: uuid
        - name: min_price
          in: query
          schema:
            type: number
        - name: max_price
          in: query
          schema:
            type: number
      responses:
        '200':
          description: List of cabins
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CabinListResponse'

  /cabins/{id}:
    get:
      summary: Get cabin details
      tags:
        - Cabins
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Cabin details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CabinDetail'

  /cabins/availability:
    get:
      summary: Check cabin availability
      tags:
        - Cabins
      security: []
      parameters:
        - name: voyage_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: cabin_type_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Availability info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvailabilityResponse'

  # Orders
  /orders:
    get:
      summary: List orders
      tags:
        - Orders
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [created, pending_payment, paid, confirmed, completed, cancelled]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'

    post:
      summary: Create order
      tags:
        - Orders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'

  /orders/{id}:
    get:
      summary: Get order details
      tags:
        - Orders
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetail'

  /orders/{id}/cancel:
    post:
      summary: Cancel order
      tags:
        - Orders
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Order cancelled

  # Payments
  /payments:
    post:
      summary: Create payment
      tags:
        - Payments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
      responses:
        '201':
          description: Payment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'

  /payments/callback:
    post:
      summary: Payment callback (webhook)
      tags:
        - Payments
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Callback processed

  # Users
  /users/profile:
    get:
      summary: Get user profile
      tags:
        - Users
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    put:
      summary: Update user profile
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Profile updated

  /users/frequent-passengers:
    get:
      summary: List frequent passengers
      tags:
        - Users
      responses:
        '200':
          description: List of passengers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FrequentPassenger'

    post:
      summary: Add frequent passenger
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateFrequentPassengerRequest'
      responses:
        '201':
          description: Passenger added

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Auth
    LoginRequest:
      type: object
      properties:
        phone:
          type: string
        code:
          type: string
          description: SMS verification code

    LoginResponse:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'

    # User
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_no:
          type: string
        phone:
          type: string
        nickname:
          type: string
        avatar_url:
          type: string
        member_level:
          type: integer
        points_balance:
          type: integer

    UpdateUserRequest:
      type: object
      properties:
        nickname:
          type: string
        avatar_url:
          type: string

    FrequentPassenger:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        name_en:
          type: string
        id_type:
          type: string
          enum: [id_card, passport, other]
        id_number:
          type: string
        phone:
          type: string

    CreateFrequentPassengerRequest:
      type: object
      properties:
        name:
          type: string
        name_en:
          type: string
        id_type:
          type: string
        id_number:
          type: string
        phone:
          type: string

    # Cruise
    Cruise:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name_cn:
          type: string
        name_en:
          type: string
        code:
          type: string
        gross_tonnage:
          type: integer
        passenger_capacity:
          type: integer
        cover_images:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, inactive, maintenance]

    CruiseDetail:
      allOf:
        - $ref: '#/components/schemas/Cruise'
        - type: object
          properties:
            company:
              type: object
            cabin_types:
              type: array
              items:
                $ref: '#/components/schemas/CabinType'
            facilities:
              type: array
              items:
                $ref: '#/components/schemas/Facility'

    CruiseListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Cruise'
        pagination:
          $ref: '#/components/schemas/Pagination'

    CreateCruiseRequest:
      type: object
      properties:
        company_id:
          type: string
          format: uuid
        name_cn:
          type: string
        name_en:
          type: string
        code:
          type: string
        gross_tonnage:
          type: integer
        passenger_capacity:
          type: integer

    UpdateCruiseRequest:
      allOf:
        - $ref: '#/components/schemas/CreateCruiseRequest'

    # Cabin
    CabinType:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        code:
          type: string
        min_area_sqm:
          type: number
        max_area_sqm:
          type: number
        standard_guests:
          type: integer
        max_guests:
          type: integer
        feature_tags:
          type: array
          items:
            type: string

    Cabin:
      type: object
      properties:
        id:
          type: string
          format: uuid
        cabin_number:
          type: string
        cabin_type:
          $ref: '#/components/schemas/CabinType'
        deck_number:
          type: integer
        price:
          type: number

    CabinDetail:
      allOf:
        - $ref: '#/components/schemas/Cabin'
        - type: object
          properties:
            voyage:
              type: object
            amenities:
              type: array
              items:
                type: string

    CabinListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Cabin'
        pagination:
          $ref: '#/components/schemas/Pagination'

    AvailabilityResponse:
      type: object
      properties:
        voyage_id:
          type: string
          format: uuid
        available_count:
          type: integer
        price_range:
          type: object
          properties:
            min:
              type: number
            max:
              type: number

    # Facility
    Facility:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        category:
          type: object
        deck_number:
          type: integer
        is_free:
          type: boolean

    # Order
    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_no:
          type: string
        status:
          type: string
          enum: [created, pending_payment, paid, confirmed, pending_departure, departed, completed, cancelled, refund_requested, refund_processing, refunded]
        total_amount:
          type: number
        paid_amount:
          type: number
        currency:
          type: string
        created_at:
          type: string
          format: date-time

    OrderDetail:
      allOf:
        - $ref: '#/components/schemas/Order'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/OrderItem'
            passengers:
              type: array
              items:
                $ref: '#/components/schemas/Passenger'
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'

    OrderListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Order'
        pagination:
          $ref: '#/components/schemas/Pagination'

    CreateOrderRequest:
      type: object
      properties:
        voyage_id:
          type: string
          format: uuid
        cabin_id:
          type: string
          format: uuid
        passengers:
          type: array
          items:
            $ref: '#/components/schemas/CreatePassengerRequest'

    OrderItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        cabin:
          $ref: '#/components/schemas/Cabin'
        quantity:
          type: integer
        unit_price:
          type: number
        total_price:
          type: number

    # Passenger
    Passenger:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name_cn:
          type: string
        name_en:
          type: string
        id_type:
          type: string
        id_number:
          type: string
        phone:
          type: string

    CreatePassengerRequest:
      type: object
      properties:
        name_cn:
          type: string
        name_en:
          type: string
        id_type:
          type: string
          enum: [id_card, passport, other]
        id_number:
          type: string
        phone:
          type: string

    # Payment
    Payment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        payment_no:
          type: string
        channel:
          type: string
          enum: [wechat, alipay, unionpay]
        amount:
          type: number
        status:
          type: string
          enum: [pending, processing, success, failed, refunded]
        paid_at:
          type: string
          format: date-time

    CreatePaymentRequest:
      type: object
      properties:
        order_id:
          type: string
          format: uuid
        channel:
          type: string
        return_url:
          type: string

    # Common
    Pagination:
      type: object
      properties:
        page:
          type: integer
        page_size:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer

    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
