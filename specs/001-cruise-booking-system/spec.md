# Feature Specification: 邮轮舱位预订平台 (CruiseBooking)

**Feature ID**: 001-cruise-booking-system  
**Created**: 2026-02-10  
**Status**: Draft  
**Input**: Based on Constitution v1.0.0 and 功能列表.md Category II & III

---

## Overview

邮轮舱位预订平台是一个面向邮轮舱位销售的全流程电商系统，包含三个前端应用（微信小程序前台、Web网页前台、Web管理后台）及统一后端服务。系统分四个阶段交付：MVP（1-2月）、V1.0（3-4月）、V1.5（5-6月）、V2.0（7-9月）。

---

## User Scenarios & Testing

### User Story 1 - 邮轮浏览与舱位选择 (Priority: P1)

作为潜在邮轮旅客，我希望浏览不同邮轮的信息、查看舱房类型和设施，以便选择合适的邮轮和舱位。

**Why this priority**: 这是用户旅程的起点，没有浏览功能就无法产生预订。这是系统存在的核心价值。

**Independent Test**: 用户可以通过前台（Web/小程序）查看邮轮列表、详情页、舱房类型和设施介绍，无需登录即可完成浏览。

**Acceptance Scenarios**:

1. **Given** 用户访问前台首页，**When** 用户浏览邮轮列表页，**Then** 系统显示邮轮卡片（封面图、名称、吨位、容纳人数、舱房类型数量），支持筛选和排序
2. **Given** 用户点击邮轮卡片，**When** 用户进入邮轮详情页，**Then** 系统显示轮播图、基本参数、舱房类型列表（可展开）、设施导览（分类Tab）、关联航线入口
3. **Given** 用户在舱房类型列表，**When** 用户展开某舱型，**Then** 系统显示该舱型主图、名称、面积、人数、起始价格、详细介绍和完整图册
4. **Given** 用户在设施导览Tab，**When** 用户切换分类，**Then** 系统显示该分类下的设施卡片（图片、名称、位置、是否免费）

---

### User Story 2 - 在线预订与支付 (Priority: P1)

作为已选择邮轮的旅客，我希望完成在线下单并支付，以便锁定舱位。

**Why this priority**: 预订和支付是电商系统的核心转化环节，直接影响业务收入。

**Independent Test**: 用户可以完成从选舱到支付的全流程，订单状态正确流转，库存被锁定和释放。

**Acceptance Scenarios**:

1. **Given** 用户在舱位详情页，**When** 用户点击「立即预订」，**Then** 系统进入预订流程：选择航次日期→选择舱型→选择具体舱位/自动分配→填写乘客信息→确认订单金额→提交订单
2. **Given** 用户提交订单，**When** 订单创建成功，**Then** 系统锁定舱位15分钟，显示支付页面，发送订单通知
3. **Given** 用户在支付页面，**When** 用户完成支付，**Then** 系统确认支付、更新订单状态为「已付款」、确认库存锁定、发送支付成功通知
4. **Given** 用户未在15分钟内支付，**When** 超时到达，**Then** 系统自动取消订单、释放舱位、发送超时通知

---

### User Story 3 - 订单管理与退改 (Priority: P1)

作为已预订用户，我希望查看和管理我的订单，并在需要时申请退改。

**Why this priority**: 订单管理是用户完成购买后的核心需求，退改功能是售后服务的关键组成部分。

**Independent Test**: 用户可以在「我的订单」中查看订单列表和详情，根据规则发起退改申请，后台可以审核并处理。

**Acceptance Scenarios**:

1. **Given** 用户已登录，**When** 用户进入「我的订单」页面，**Then** 系统显示全部订单列表，支持按状态Tab筛选（全部、待付款、已付款、已确认、已出行、已取消、退款中、已退款）
2. **Given** 用户在订单列表，**When** 用户点击某订单，**Then** 系统显示订单详情：航线信息、舱位信息、金额、状态、乘客信息、支付记录、操作按钮
3. **Given** 用户在订单详情页且订单符合退改条件，**When** 用户点击「申请退改」，**Then** 系统显示退改规则和可退金额，用户提交申请后订单状态变为「退款申请中」
4. **Given** 后台运营人员登录，**When** 审核通过退改申请，**Then** 系统自动发起退款、释放库存、更新订单状态为「已退款」、通知用户

---

### User Story 4 - 邮轮与舱位后台管理 (Priority: P1)

作为运营人员，我希望在后台管理邮轮信息、舱房类型、设施、舱位库存和定价，以便维护商品数据。

**Why this priority**: 后台管理是系统运营的基础，没有商品数据管理就无法支撑前台业务。

**Independent Test**: 运营人员可以通过管理后台完成邮轮、舱房类型、设施、舱位的CRUD操作，配置库存和价格。

**Acceptance Scenarios**:

1. **Given** 运营人员登录管理后台，**When** 进入邮轮管理页面，**Then** 可以查看邮轮列表、新建/编辑邮轮（含多图上传、富文本编辑）、批量上下架
2. **Given** 运营人员在舱房类型管理页面，**When** 新建舱房类型，**Then** 可以配置所属邮轮、类型名称/代码、面积范围、人数、床型、特色标签、富文本介绍、图片画廊、设施清单
3. **Given** 运营人员在舱位管理页面，**When** 配置舱位库存，**Then** 可以设置各航次各舱型的总库存、预警阈值，系统自动计算可用库存
4. **Given** 运营人员在价格管理页面，**When** 设置舱位定价，**Then** 可以使用价格日历按日期/人数/舱型设置基础价格、儿童价、单人补差、节假日加价、早鸟优惠等

---

### User Story 5 - 用户认证与账户管理 (Priority: P2)

作为平台用户，我希望通过微信、手机号等多种方式注册登录，并管理我的常用乘客信息。

**Why this priority**: 用户认证是个性化服务和订单管理的前提，但用户可以先浏览再登录。

**Independent Test**: 用户可以使用微信小程序一键登录、网页手机号+验证码登录、微信/支付宝扫码登录，系统统一管理用户档案和常用乘客信息。

**Acceptance Scenarios**:

1. **Given** 用户访问小程序，**When** 点击微信一键登录，**Then** 系统获取用户授权、手机号，自动创建用户档案
2. **Given** 用户访问网页前台，**When** 选择手机号登录并输入验证码，**Then** 系统验证通过并登录，自动创建用户档案
3. **Given** 用户已在个人中心，**When** 添加常用乘客信息，**Then** 系统保存姓名、证件信息、联系方式，下次预订时可一键选择
4. **Given** 用户使用一种方式登录，**When** 在个人中心绑定其他登录方式，**Then** 系统关联同一用户档案，支持多方式登录

---

### User Story 6 - 消息通知与提醒 (Priority: P2)

作为平台用户，我希望在关键节点收到订单状态变更、支付结果等通知。

**Why this priority**: 及时的通知提升用户体验和订单完成率，但属于增强功能而非核心流程阻塞点。

**Independent Test**: 系统在订单创建、支付成功、订单确认、退改审核等节点自动发送通知，支持多渠道（微信小程序订阅消息、服务号模板消息、站内消息、短信）。

**Acceptance Scenarios**:

1. **Given** 用户成功提交订单，**When** 订单创建完成，**Then** 系统发送下单成功通知（微信小程序订阅消息/站内消息）
2. **Given** 用户完成支付，**When** 支付回调成功，**Then** 系统发送支付成功通知，包含订单金额、支付时间
3. **Given** 舱位库存低于预警阈值，**When** 实时库存计算触发预警，**Then** 系统自动通知运营人员（后台消息中心/邮件/企业微信）
4. **Given** 后台运营人员配置通知模板，**When** 修改模板内容并启用，**Then** 后续发送的通知使用新模板内容

---

### User Story 7 - 智能推荐与决策支持 (Priority: P3)

作为潜在旅客，我希望系统根据我的偏好智能推荐舱位，并查看价格趋势和进行舱位对比。

**Why this priority**: 智能推荐和决策工具提升用户体验和转化率，但属于V1.5增强功能，非MVP必需。

**Independent Test**: 系统基于用户浏览历史、收藏、预算等推荐舱位，提供日历视图展示价格，支持最多3个舱位并排对比。

**Acceptance Scenarios**:

1. **Given** 用户登录并浏览过多个舱位，**When** 用户访问首页，**Then** 系统在个性化推荐区展示AI推荐的舱位卡片流
2. **Given** 用户在航线详情页，**When** 切换至日历视图，**Then** 系统显示各出发日期及最低价格，用颜色标识价格区间（绿=低价、黄=常规、红=高价）
3. **Given** 用户选择多个舱位加入对比，**When** 用户打开对比工具，**Then** 系统并排显示最多3个舱位的价格、面积、位置、设施、评分等维度对比
4. **Given** 用户在价格趋势页面，**When** 查看某航线历史价格，**Then** 系统显示价格走势折线图，标注最低价时段和预订建议

---

### User Story 8 - 社交分享与社区互动 (Priority: P3)

作为已出行用户，我希望分享行程海报、发布游记评价、邀请好友同行。

**Why this priority**: 社交功能增强用户粘性和口碑传播，但属于V2.0生态化阶段功能。

**Independent Test**: 用户可以生成行程分享海报、发布图文游记、参与评价、使用邀请码邀请好友并获得奖励。

**Acceptance Scenarios**:

1. **Given** 用户已完成出行的订单，**When** 用户点击「生成海报」，**Then** 系统自动生成包含航线地图、邮轮图、出发日期、舱位信息的精美海报图片
2. **Given** 用户出行完成，**When** 系统推送评价邀请，**Then** 用户可以对航线、舱位、服务进行5星评分，上传图文/视频评价
3. **Given** 用户分享邀请链接给好友，**When** 好友通过链接下单成功，**Then** 双方自动获得优惠券/折扣奖励
4. **Given** 用户在游记社区，**When** 发布图文游记并通过审核，**Then** 内容展示在社区首页，其他用户可以点赞、收藏、评论

---

### Edge Cases

#### 库存与并发
- **What happens when** 多个用户同时预订同一舱位的最后库存？**System** 使用Redis分布式锁确保只有一个用户成功锁定，其他用户收到"库存不足"提示
- **What happens when** 用户支付时舱位已被其他用户订完？**System** 校验库存状态，若已售罄则退款并通知用户
- **What happens when** 系统故障导致库存数据不一致？**System** 通过库存变动日志和对账机制发现并修复异常

#### 支付异常
- **How does system handle** 支付回调延迟或丢失？**System** 提供主动查询机制和定时补偿任务，确保订单状态最终一致
- **How does system handle** 用户支付金额与订单金额不符？**System** 拒绝回调并记录异常，人工介入处理
- **How does system handle** 用户重复支付？**System** 检测重复流水号，自动退款重复支付金额

#### 退改规则
- **What happens when** 用户在不可退改期限后申请退款？**System** 根据配置规则拒绝申请或提示不可退改
- **What happens when** 退改规则中途变更？**System** 以订单创建时的规则为准，新订单使用新规则

#### 用户信息
- **How does system handle** 用户证件信息填写错误？**System** 提供修改入口，已确认订单需联系客服修改
- **What happens when** 用户删除常用乘客信息但该乘客有关联订单？**System** 软删除并保留关联订单中的乘客信息

---

## Requirements

### Functional Requirements

#### 邮轮管理模块 (FR-001 ~ FR-015)

- **FR-001**: 系统必须支持邮轮基本信息的CRUD操作，包括名称（中英文）、英文简称/代码（唯一标识）、所属邮轮公司、总吨位、最大容纳人数、船员人数、建造/翻新年份、尺寸参数（长度/宽度/甲板层数）、封面图（多图上传+拖拽排序）、状态（上架/下架/维护中）、排序权重

- **FR-002**: 系统必须支持舱房类型的CRUD操作，包括所属邮轮关联、类型名称、类型代码、面积范围、可住人数（标准/最大）、床型说明、特色标签、富文本详细介绍、图片画廊（多图+主图设置）、平面图、设施清单、排序权重、状态

- **FR-003**: 系统必须支持设施分类管理，可自定义分类名称、图标、排序；支持设施CRUD，包括所属邮轮、所属分类、设施名称、位置（甲板层）、开放时间、是否收费及参考价格、富文本介绍、图片、适合人群标签

- **FR-004**: 前台必须展示邮轮列表页，支持卡片式展示、筛选（名称/吨位/状态）、排序、分页

- **FR-005**: 前台邮轮详情页必须展示轮播图画廊、基本参数区块、舱房类型列表（折叠展开）、设施导览（分类Tab切换）、关联航线入口

- **FR-006**: 舱房类型展开后必须显示主图、名称、面积、人数、起始价格，点击进入查看详细介绍和完整图册

- **FR-007**: 已关联航线/舱位的邮轮不允许删除，系统必须给出明确提示

- **FR-008**: 邮轮、舱房类型、设施必须支持软删除，保留历史数据关联性

#### 舱位商品管理 (FR-009 ~ FR-020)

- **FR-009**: 系统必须支持舱位列表展示，字段包括：舱位编号、所属邮轮、所属航线、舱房类型、面积、价格区间、库存、状态；支持按邮轮/航线/舱型筛选和排序

- **FR-010**: 系统必须支持三级分类管理：邮轮→航线→舱型；分类支持增删改查、排序、关联图标

- **FR-011**: 舱位SKU属性必须包括：舱位等级、床型（大床/双床/上下铺）、面积、甲板层数、位置（前/中/后）、朝向（左舷/右舷）、是否有窗/阳台、附属设施清单；支持属性模板复用

- **FR-012**: 系统必须实现实时库存管理：总库存、已售数量、锁定数量（未支付订单）、可用库存自动计算；支持库存预警阈值设置，低于阈值时自动通知运营人员

- **FR-013**: 库存变动必须记录完整日志，包括变动类型、数量、时间、关联订单、操作人员

- **FR-014**: 系统必须支持多维度价格矩阵设置：基础价格、儿童价格、单人补差价、节假日加价、早鸟优惠价、连住折扣；支持按日期区间批量设置

- **FR-015**: 价格日历必须可视化展示，支持点击日期查看和编辑价格

- **FR-016**: 舱位列表视图必须支持列表视图和地图视图（甲板图）两种浏览模式

- **FR-017**: 舱位卡片必须展示主图、舱型、面积、价格、剩余库存量级（充足/紧张/即将售罄）

- **FR-018**: 支持按价格、面积、评分排序舱位

- **FR-019**: 舱位详情页必须展示图片轮播、参数信息、价格日历、所属邮轮链接、甲板位置示意图、「立即预订」按钮

#### 预订流程 (FR-021 ~ FR-030)

- **FR-021**: 预订流程必须包括：选择航次日期→选择舱型→选择具体舱位或系统自动分配→填写乘客人数→填写乘客基本信息→确认订单金额明细→提交订单

- **FR-022**: 订单提交后舱位必须进入「锁定」状态，锁定时长为15分钟

- **FR-023**: 超时未支付的订单必须自动取消并释放舱位，同时通知用户

- **FR-024**: 乘客信息必须包括：姓名（中/英文）、证件类型（身份证/护照/其他）、证件号码、手机号、邮箱、紧急联系人及电话、特殊需求备注

- **FR-025**: 系统必须支持保存常用乘客信息，下次预订时可一键选择自动填充

- **FR-026**: 订单金额明细必须清晰展示：舱位价格、人数、优惠折扣、税费、应付总额

- **FR-027**: 提交订单前必须进行库存校验，确保舱位可售

- **FR-028**: 支持一键锁定舱位（支付前临时锁定，15分钟倒计时），锁定期间舱位对其他用户显示为「锁定中」

- **FR-029**: 支持分期付款模式（定金+尾款），定金比例、尾款截止日可按航线配置

- **FR-030**: 支持团队批量预订：上传乘客名单Excel批量录入、团队专属价格、独立管理页面

#### 订单与支付 (FR-031 ~ FR-050)

- **FR-031**: 后台订单列表必须展示全部订单，支持按订单号/手机号/航线/日期/状态筛选；状态标签页：全部、待付款、已付款、已确认、已出行、已取消、退款中、已退款

- **FR-032**: 订单状态流转必须完整记录：已创建→待付款→已付款→已确认（出票）→待出行→已出行→已完成；异常状态：已取消、退款申请中、退款处理中、已退款

- **FR-033**: 每次状态变更必须记录操作人、操作时间、备注

- **FR-034**: 在线支付必须支持：微信支付（小程序JSAPI + H5/网页Native）、支付宝支付、银联支付

- **FR-035**: 支付回调必须验证签名，支付金额必须与订单金额严格校验，防止篡改

- **FR-036**: 支付超时必须自动关闭订单并释放舱位

- **FR-037**: 退改规则必须可按距出发日天数阶梯配置（如>30天全退、15-30天退80%、7-15天退50%、<7天不可退），比例可手动编辑

- **FR-038**: 用户必须在「我的订单」中发起退改申请，填写原因和退款账户

- **FR-039**: 后台必须支持退改申请审核，审核通过后自动发起退款并释放库存

- **FR-040**: 财务对账报表必须每日自动生成，包括：订单金额汇总、实收金额、退款金额、手续费；支持按日/周/月查看

- **FR-041**: 支持导出订单Excel，包含完整订单信息和乘客信息

- **FR-042**: 支持多币种支付（CNY/USD/HKD/JPY），汇率自动从外部API获取并缓存，用户选择币种后全站价格同步切换

- **FR-043**: 支持电子船票生成（PDF + QR码），集成微信卡包

- **FR-044**: 出团通知书支持PDF上传，客户可在前台查看并保存至手机，系统自动弹出消息通知

- **FR-045**: 出行倒计时组件显示在「我的订单」和首页，出发前自动推送行前准备清单

#### 用户系统 (FR-046 ~ FR-060)

- **FR-046**: 小程序必须支持微信一键授权登录，获取用户手机号

- **FR-047**: 网页前台必须支持手机号+验证码登录、微信扫码登录、支付宝扫码登录

- **FR-048**: 登录后必须自动创建用户档案，不同登录方式可绑定至同一用户

- **FR-049**: 「我的订单」必须按状态Tab筛选，订单卡片展示航线信息、舱位信息、金额、状态、操作按钮

- **FR-050**: 员工账号管理必须支持账号CRUD、角色分配；基于Casbin RBAC权限控制

- **FR-051**: 预设角色必须包括：超级管理员、运营人员、财务人员、客服人员

- **FR-052**: 所有后台操作必须记录操作日志

- **FR-053**: 店铺/品牌信息配置必须包括：店铺名称、Logo、联系方式、公司介绍（富文本）、客服信息、备案信息

- **FR-054**: 支持证件OCR识别：拍照/上传护照/身份证图片，自动识别姓名、证件号、有效期等信息并填入表单

- **FR-055**: 支持历史乘客快填：自动从历史订单提取乘客信息列表，下单时一键选择

- **FR-056**: 客户生命周期CRM：从潜在客户→首航→复购的全生命周期管理，客户标签体系，客户画像（消费偏好、出行频次、消费能力分层）

#### 消息通知 (FR-061 ~ FR-070)

- **FR-061**: 订单通知必须覆盖：下单成功、支付成功、订单确认（出票）、退改审核结果

- **FR-062**: 通知渠道必须包括：微信小程序订阅消息、微信服务号模板消息、站内消息、短信（可配置）

- **FR-063**: 后台必须可配置每种通知类型的开关及通知模板内容

- **FR-064**: 库存预警通知必须在可用库存低于阈值时自动触发，通知运营人员

- **FR-065**: 预警通知渠道必须包括：后台消息中心、邮件、企业微信

- **FR-066**: 价格变动提醒：用户可「关注」航线/舱型，价格变动超过阈值时推送通知

- **FR-067**: 预订进度追踪：订单状态全流程可视化时间轴，每个节点实时推送变更通知

#### 数据统计 (FR-071 ~ FR-085)

- **FR-071**: 数据看板必须展示今日概览：今日订单数、今日营收、今日新用户、今日页面访问量

- **FR-072**: 趋势图必须包括：近7/30天订单量趋势、营收趋势

- **FR-073**: 舱位热度排行必须展示：最受欢迎的航线、舱型

- **FR-074**: 库存概览必须使用饼图展示各航次各舱型库存分布

- **FR-075**: 收益管理看板必须展示核心指标：RevPAR（每可用舱位收益）、上座率、渠道贡献比、客单价、转化率；支持按航线、时间段钻取

- **FR-076**: 智能预警系统必须覆盖：库存低水位预警、价格异常波动预警、超卖风险预警、支付异常预警；预警规则可自定义，通知方式可配置

- **FR-077**: 渠道库存分配必须支持多渠道独立库存池：直销、OTA、旅行社、分销各分配独立库存；渠道间库存可调拨；超卖保护机制

- **FR-078**: 动态定价引擎必须根据库存水位、距离出发日天数、历史需求数据、竞品价格自动调价；支持定价规则配置和手动覆盖

- **FR-079**: 自动化营销引擎必须基于用户行为触发：浏览未购买→推送价格或时间；加购未支付→提醒通知；出行完成→邀请评价+推荐下次航程

#### 智能与增强功能 (FR-080 ~ FR-100)

- **FR-080**: 智能舱位推荐必须基于用户偏好（历史浏览、收藏、预算范围、出行人数、旅行风格标签）AI推荐最匹配舱位

- **FR-081**: 推荐算法权重参数必须可在后台配置

- **FR-082**: 航线日历视图必须以日历形式展示出发日期，每个日期显示最低价格，颜色编码标识价格区间

- **FR-083**: 价格趋势分析必须展示历史价格走势折线图，标注最低价时段，预测最佳预订时机

- **FR-084**: 舱位对比工具必须支持最多3个舱位并排对比，维度包括价格、面积、位置、设施、用户评分、甲板层数、舱型等级

- **FR-085**: 实时舱位状态必须通过WebSocket推送库存变化，显示「刚刚有N人正在查看」、「已售出X间」等紧迫感信息

- **FR-086**: 在线客服必须集成AI智能客服（FAQ自动回复）+人工客服转接，支持文字、图片发送

- **FR-087**: 天气与港口信息必须展示航线沿途天气预报、港口停靠信息（时间、介绍、附近景点/交通）

- **FR-088**: 360°全景VR舱位预览集成

- **FR-089**: 交互式甲板图开发（SVG/Canvas可点击甲板）

- **FR-090**: 竞品监控看板

#### 社交与社区 (FR-091 ~ FR-100)

- **FR-091**: 行程分享海报必须基于订单信息自动生成精美海报图片（航线地图+邮轮图+出发日期+舱位信息），支持一键保存/分享到微信朋友圈

- **FR-092**: 海报模板必须可在后台配置和更换

- **FR-093**: 邀请同行优惠必须支持分享专属链接/二维码，好友下单成功后双方各获得优惠券/折扣

- **FR-094**: 用户评价体系必须在出行完成后邀请评价：航线评分、舱位评分、服务评分（5星制），支持图文+视频评价

- **FR-095**: 评价必须后台审核后展示，评价数据自动关联到航线/舱位详情页

- **FR-096**: 旅行游记社区必须支持UGC图文游记发布，点赞、收藏、评论功能，后台审核管理，优质游记推荐至首页

- **FR-097**: 拼团出行必须支持陌生人拼团/拼舱，后台设置拼团规则（最低成团人数、拼团价格、拼团有效期），前台展示正在拼团的航次列表

- **FR-098**: 积分商城必须支持商品管理、兑换流程、库存管理

- **FR-099**: 多语言支持必须覆盖：中文简体/繁体、英文、日文、韩文；支持内容翻译管理

- **FR-100**: 会员等级体系+积分系统基础

---

### Key Entities

#### 邮轮 (Cruise)
- **代表**: 一艘具体的邮轮船只
- **关键属性**: ID、名称（中/英）、英文代码、所属公司、总吨位、最大容纳人数、船员人数、建造年份、翻新年份、长度、宽度、甲板层数、封面图URLs、状态、排序权重、创建/更新时间
- **关联**: 一对多 舱房类型、一对多 设施、一对多 航线

#### 舱房类型 (CabinType)
- **代表**: 邮轮上的舱房类别（如内舱房、海景房、阳台房等）
- **关键属性**: ID、所属邮轮ID、类型名称、类型代码、最小面积、最大面积、标准入住人数、最大入住人数、床型说明、特色标签、详细介绍（富文本）、图片URLs、平面图URL、设施清单、排序权重、状态
- **关联**: 多对一 邮轮、一对多 舱位

#### 设施 (Facility)
- **代表**: 邮轮上的娱乐、餐饮、服务设施
- **关键属性**: ID、所属邮轮ID、设施分类ID、设施名称、位置（甲板层）、开放时间、是否收费、参考价格、详细介绍（富文本）、图片URLs、适合人群标签、排序权重、状态
- **关联**: 多对一 邮轮、多对一 设施分类

#### 航线 (Route)
- **代表**: 邮轮的航行路线
- **关键属性**: ID、航线名称、出发港口、目的港口、途经港口、航行天数、线路描述、状态
- **关联**: 多对一 邮轮、一对多 航次

#### 航次 (Voyage)
- **代表**: 特定航线的具体出发日期实例
- **关键属性**: ID、所属航线ID、出发日期、返回日期、状态
- **关联**: 多对一 航线、一对多 舱位库存

#### 舱位 (Cabin)
- **代表**: 具体的可预订舱位SKU
- **关键属性**: ID、舱位编号、所属航次ID、舱房类型ID、舱位等级、床型、面积、甲板层数、位置（前/中/后）、朝向、是否有窗/阳台、附属设施、状态
- **关联**: 多对一 航次、多对一 舱房类型、一对多 库存记录、一对多 价格记录

#### 库存记录 (Inventory)
- **代表**: 特定舱位在特定日期的库存状态
- **关键属性**: ID、舱位ID、航次ID、总库存、已售数量、锁定数量、可用库存、预警阈值
- **关联**: 多对一 舱位、多对一 航次

#### 价格记录 (Price)
- **代表**: 舱位在特定日期的定价
- **关键属性**: ID、舱位ID、航次ID、日期、基础价格、儿童价格、单人补差价、节假日加价、早鸟优惠价、连住折扣、币种
- **关联**: 多对一 舱位、多对一 航次

#### 订单 (Order)
- **代表**: 用户的预订订单
- **关键属性**: ID、订单号、用户ID、订单状态、总金额、优惠金额、实付金额、币种、支付时间、确认时间、出行日期、完成日期、取消时间、创建/更新时间
- **关联**: 多对一 用户、一对多 订单项、一对多 乘客信息、一对多 支付记录

#### 订单项 (OrderItem)
- **代表**: 订单中的具体舱位项
- **关键属性**: ID、订单ID、舱位ID、航次ID、数量、单价、小计金额
- **关联**: 多对一 订单、多对一 舱位

#### 乘客信息 (Passenger)
- **代表**: 订单中的乘客详细信息
- **关键属性**: ID、订单ID、姓名（中/英）、证件类型、证件号码、手机号、邮箱、紧急联系人、紧急联系电话、特殊需求备注
- **关联**: 多对一 订单

#### 用户 (User)
- **代表**: 平台注册用户
- **关键属性**: ID、用户编号、微信OpenID、手机号、邮箱、昵称、头像、注册时间、最后登录时间、会员等级、积分余额、状态
- **关联**: 一对多 订单、一对多 常用乘客、一对多 登录记录

#### 常用乘客 (FrequentPassenger)
- **代表**: 用户保存的常用乘客信息
- **关键属性**: ID、用户ID、姓名、证件类型、证件号码、手机号、邮箱、关系标签
- **关联**: 多对一 用户

#### 员工账号 (Staff)
- **代表**: 后台管理系统操作人员
- **关键属性**: ID、账号名、密码（加密）、姓名、邮箱、手机号、角色ID、最后登录时间、状态
- **关联**: 多对一 角色

#### 角色 (Role)
- **代表**: RBAC权限角色
- **关键属性**: ID、角色名称、角色代码、权限列表、描述
- **关联**: 一对多 员工账号

#### 退改申请 (RefundRequest)
- **代表**: 用户的退改申请记录
- **关键属性**: ID、订单ID、申请类型（退/改）、申请原因、申请金额、退款账户、状态、审核人、审核时间、审核备注、创建时间
- **关联**: 多对一 订单

#### 通知记录 (Notification)
- **代表**: 系统发送的通知记录
- **关键属性**: ID、用户ID、通知类型、通知渠道、标题、内容、是否已读、发送时间
- **关联**: 多对一 用户

#### 游记 (Travelogue)
- **代表**: 用户发布的旅行游记
- **关键属性**: ID、用户ID、标题、内容（富文本）、图片URLs、关联航线ID、点赞数、收藏数、评论数、审核状态、创建/更新时间
- **关联**: 多对一 用户、多对一 航线

---

## Success Criteria

### Measurable Outcomes

#### 业务指标

- **SC-001**: 用户可以从浏览邮轮到完成支付的端到端流程在5分钟内完成（不含填写乘客信息时间）

- **SC-002**: 系统必须支持至少1000个并发用户同时浏览舱位，页面加载时间不超过2秒

- **SC-003**: 库存锁定的并发操作准确率必须达到99.99%，杜绝超卖现象

- **SC-004**: 支付成功率（发起支付到支付成功）必须达到95%以上

- **SC-005**: 订单状态流转的准确性必须达到100%，不允许出现状态不一致或丢失

- **SC-006**: 用户通过小程序完成预订的比例在MVP阶段达到60%以上

- **SC-007**: 智能推荐功能的点击率（推荐位点击/展示）达到10%以上

- **SC-008**: 用户重复预订率（复购用户/总用户）在V2.0阶段达到30%以上

#### 系统指标

- **SC-009**: API响应时间P95不超过500ms（不含第三方支付接口）

- **SC-010**: 系统可用性达到99.9%（每月停机时间不超过43分钟）

- **SC-011**: 数据备份必须每日执行，恢复时间目标（RTO）不超过4小时

- **SC-012**: 消息通知到达率在95%以上（微信订阅消息、短信等）

- **SC-013**: 搜索功能（Meilisearch）返回结果时间不超过200ms

#### 用户体验指标

- **SC-014**: 用户任务完成率（开始预订→提交订单）达到70%以上

- **SC-015**: 用户投诉率（投诉订单/总订单）低于1%

- **SC-016**: 客服工单平均处理时间不超过24小时

- **SC-017**: 页面首屏加载时间（LCP）不超过2.5秒（Web端）

#### 质量保障指标

- **SC-018**: 所有代码（后端+三个前端）测试覆盖率必须达到100%

- **SC-019**: 所有API必须有对应的Swagger/OpenAPI 3.1文档

- **SC-020**: 代码审查通过率100%，不允许未经审查的代码合并到主分支

---

## Constraints & Assumptions

### Constraints

1. **技术栈约束**: 必须严格遵循Constitution v1.0.0中定义的技术栈，不得使用未批准的技术

2. **测试覆盖率约束**: 所有代码必须达到100%测试覆盖率，否则无法合并

3. **合规约束**: 支付功能必须符合中国支付行业监管要求，用户数据必须符合个人信息保护法

4. **性能约束**: 系统必须能在Kubernetes集群中水平扩展以应对流量峰值

5. **安全约束**: 所有敏感操作（支付、退款、权限变更）必须记录审计日志

### Assumptions

1. **用户假设**: 目标用户主要为中国大陆居民，具备基本的智能手机和微信使用能力

2. **业务假设**: 邮轮供应商能够提供准确的舱位库存和定价数据

3. **技术假设**: 微信支付、支付宝等第三方支付接口稳定可用

4. **运营假设**: 平台配备足够的运营人员进行订单审核、退改处理和客服响应

5. **市场假设**: 邮轮旅游市场需求稳定增长，用户对在线预订接受度高

---

## Dependencies

### External Dependencies

1. **微信支付/支付宝**: 在线支付功能依赖第三方支付平台的API稳定性和政策合规

2. **Meilisearch**: 搜索功能依赖Meilisearch服务的可用性和性能

3. **MinIO**: 媒体存储依赖MinIO对象存储服务

4. **NATS JetStream**: 消息队列依赖NATS服务的可用性

5. **天气API**: 天气与港口信息功能依赖第三方天气数据服务

6. **汇率API**: 多币种支付依赖外部汇率数据服务

7. **OCR服务**: 证件识别依赖第三方OCR API

### Internal Dependencies

1. **用户系统**: 订单功能依赖用户认证系统的用户档案数据

2. **邮轮管理**: 舱位管理依赖邮轮和舱房类型的基础数据

3. **库存系统**: 预订功能依赖库存系统的实时库存计算

4. **支付系统**: 订单完成依赖支付系统的回调处理

5. **通知系统**: 订单状态流转依赖通知系统的消息发送

---

## Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| 并发预订导致超卖 | 高 | 中 | Redis分布式锁、库存校验、幂等设计 |
| 支付回调丢失或延迟 | 高 | 中 | 主动查询机制、定时补偿任务、对账机制 |
| 第三方服务不可用 | 高 | 低 | 熔断降级、缓存策略、备用方案 |
| 性能瓶颈无法支撑大促 | 高 | 中 | Kubernetes自动扩缩容、性能压测、缓存优化 |
| 数据安全泄露 | 高 | 低 | 加密存储、访问控制、审计日志、安全扫描 |
| 测试覆盖率无法达标 | 中 | 中 | 测试驱动开发、代码审查、CI强制检查 |
| 需求变更频繁 | 中 | 高 | 敏捷开发、版本控制、优先级管理 |

---

## Timeline

### Phase 1: MVP (Months 1-2)

**Sprint 1 (Weeks 1-2):** 项目基建 + 邮轮介绍模块
- 后端：Go项目初始化、数据库设计、邮轮/舱房类型/设施CRUD API
- 管理后台：Nuxt初始化、登录、Layout、邮轮/舱房/设施管理页面
- 网页前台：Nuxt SSR初始化、首页、邮轮列表/详情页
- 小程序：uni-app初始化、微信登录、首页、邮轮列表/详情页

**Sprint 2 (Weeks 3-4):** 舱位管理 + 浏览
- 后端：航线/航次/舱位表设计、舱位CRUD+库存+定价API
- 管理后台：航线/航次/舱位管理、库存预警、价格日历
- 前台：舱位列表页、舱位详情页

**Sprint 3 (Weeks 5-6):** 下单 + 支付 + 订单管理
- 后端：订单表设计、下单API、微信支付集成、订单状态机
- 管理后台：订单列表/详情页、订单操作
- 前台：下单流程、支付结果页、我的订单

**Sprint 4 (Weeks 7-8):** 用户系统 + 退改 + 通知 + 对账 + 数据统计
- 后端：用户/员工/角色表、退改API、通知发送、对账报表、数据统计
- 管理后台：员工/权限管理、退改审核、通知配置、对账页面、数据看板
- 前台：个人中心、退改申请、站内消息

### Phase 2: V1.0 (Months 3-4)

**Sprints 5-6:** 岸上游 + 电子船票 + 出行倒计时 + 在线客服 + 常用乘客快填

**Sprints 7-8:** 评价系统 + 行程分享海报 + 会员等级 + 积分系统 + 邀请优惠

### Phase 3: V1.5 (Months 5-6)

**Sprints 9-10:** 智能推荐 + VR预览 + 交互甲板图 + 航线日历 + 价格趋势 + 舱位对比

**Sprints 11-12:** 动态定价 + 多币种 + OCR识别 + 分期付款 + 团队批量预订

### Phase 4: V2.0 (Months 7-9)

**Sprints 13-14:** 游记社区 + 拼团出行 + 积分商城

**Sprints 15-16:** 多渠道分销 + 智能运营 + 多语言 + WebSocket实时状态 + 天气港口信息

---

## Appendix

### A. 状态定义

#### 邮轮状态
- `active`: 上架，前台可见
- `inactive`: 下架，前台不可见
- `maintenance`: 维护中，不可预订

#### 舱位状态
- `available`: 可售
- `locked`: 锁定中（待支付）
- `sold`: 已售
- `offline`: 下线

#### 订单状态
- `created`: 已创建
- `pending_payment`: 待付款
- `paid`: 已付款
- `confirmed`: 已确认（出票）
- `pending_departure`: 待出行
- `departed`: 已出行
- `completed`: 已完成
- `cancelled`: 已取消
- `refund_requested`: 退款申请中
- `refund_processing`: 退款处理中
- `refunded`: 已退款

### B. 角色权限矩阵

| 功能模块 | 超级管理员 | 运营人员 | 财务人员 | 客服人员 |
|---------|-----------|---------|---------|---------|
| 邮轮管理 | ✓ | ✓ | ✗ | ✗ |
| 舱位管理 | ✓ | ✓ | ✗ | ✗ |
| 订单管理 | ✓ | ✓ | ✓ | ✓ |
| 退改审核 | ✓ | ✗ | ✓ | ✓ |
| 用户管理 | ✓ | ✗ | ✗ | ✓ |
| 员工管理 | ✓ | ✗ | ✗ | ✗ |
| 数据统计 | ✓ | ✓ | ✓ | ✗ |
| 财务对账 | ✓ | ✗ | ✓ | ✗ |
| 系统配置 | ✓ | ✗ | ✗ | ✗ |

### C. 术语表

| 术语 | 定义 |
|------|------|
| 航次 | 特定航线在某一天的具体出发实例 |
| 舱型 | 舱房的类别，如内舱房、海景房、阳台房等 |
| SKU | 库存保有单位，此处指具体的可预订舱位 |
| RevPAR | Revenue Per Available Room，每可用舱位收益 |
| 超卖 | 销售数量超过实际库存数量 |
| 软删除 | 标记删除而非物理删除，保留数据关联性 |

---

**End of Specification**

*This specification defines the complete requirements for the CruiseBooking platform. All development work must align with this spec and the Constitution v1.0.0.*
